# Forge Factory - Render Blueprint
# Deploy Enterprise SaaS Platform to Render
# https://render.com/docs/blueprint-spec

version: "1"

services:
  # ===========================================
  # API Service (NestJS Backend)
  # ===========================================
  - type: web
    name: forge-api
    runtime: node
    region: oregon
    plan: standard
    buildCommand: pnpm install --frozen-lockfile && pnpm run prisma:generate && pnpm --filter @forge/api build
    startCommand: node apps/api/dist/main.js
    healthCheckPath: /api/docs
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      - key: DATABASE_URL
        fromDatabase:
          name: forge-db
          property: connectionString
      - key: DATABASE_DIRECT_URL
        fromDatabase:
          name: forge-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: forge-redis
          type: redis
          property: connectionString
      - key: CORS_ORIGINS
        value: https://forge-portal.onrender.com,https://forge-admin.onrender.com
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_EXPIRES_IN
        value: "15m"
      - key: JWT_REFRESH_EXPIRES_IN
        value: "7d"
      - key: SESSION_SECRET
        generateValue: true
      - key: ENCRYPTION_KEY
        generateValue: true
      - fromGroup: forge-shared
    autoDeploy: true

  # ===========================================
  # User Portal (React Frontend)
  # ===========================================
  - type: web
    name: forge-portal
    runtime: static
    region: oregon
    buildCommand: pnpm install --frozen-lockfile && pnpm --filter @forge/portal build
    staticPublishPath: apps/portal/dist
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
      - path: /*
        name: X-XSS-Protection
        value: "1; mode=block"
      - path: /*
        name: Content-Security-Policy
        value: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://forge-api.onrender.com wss://forge-api.onrender.com"
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VITE_API_URL
        value: https://forge-api.onrender.com
      - key: VITE_WS_URL
        value: wss://forge-api.onrender.com
    autoDeploy: true

  # ===========================================
  # Admin Portal (React Frontend)
  # ===========================================
  - type: web
    name: forge-admin
    runtime: static
    region: oregon
    buildCommand: pnpm install --frozen-lockfile && pnpm --filter @forge/admin build
    staticPublishPath: apps/admin/dist
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
      - path: /*
        name: X-XSS-Protection
        value: "1; mode=block"
      - path: /*
        name: Content-Security-Policy
        value: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://forge-api.onrender.com wss://forge-api.onrender.com"
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VITE_API_URL
        value: https://forge-api.onrender.com
      - key: VITE_WS_URL
        value: wss://forge-api.onrender.com
    autoDeploy: true

  # ===========================================
  # Background Workers (BullMQ Queue Processing)
  # ===========================================
  - type: worker
    name: forge-workers
    runtime: node
    region: oregon
    plan: standard
    buildCommand: pnpm install --frozen-lockfile && pnpm run prisma:generate && pnpm --filter @forge/api build
    startCommand: node apps/api/dist/workers.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: forge-db
          property: connectionString
      - key: DATABASE_DIRECT_URL
        fromDatabase:
          name: forge-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: forge-redis
          type: redis
          property: connectionString
      - key: JWT_SECRET
        sync: false
      - key: ENCRYPTION_KEY
        sync: false
      - fromGroup: forge-shared
    autoDeploy: true

  # ===========================================
  # Redis (Cache & Queue Backend)
  # ===========================================
  - type: redis
    name: forge-redis
    region: oregon
    plan: standard
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []

  # ===========================================
  # Cron Jobs
  # ===========================================
  - type: cron
    name: forge-cleanup
    runtime: node
    region: oregon
    schedule: "0 2 * * *"
    buildCommand: pnpm install --frozen-lockfile && pnpm run prisma:generate && pnpm --filter @forge/api build
    startCommand: node apps/api/dist/cron/cleanup.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: forge-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: forge-redis
          type: redis
          property: connectionString
      - fromGroup: forge-shared

  - type: cron
    name: forge-metrics
    runtime: node
    region: oregon
    schedule: "*/15 * * * *"
    buildCommand: pnpm install --frozen-lockfile && pnpm run prisma:generate && pnpm --filter @forge/api build
    startCommand: node apps/api/dist/cron/metrics.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: forge-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: forge-redis
          type: redis
          property: connectionString
      - fromGroup: forge-shared

# ===========================================
# Databases
# ===========================================
databases:
  - name: forge-db
    region: oregon
    plan: standard
    databaseName: forge_factory
    user: forge
    postgresMajorVersion: "16"
    ipAllowList: []

# ===========================================
# Environment Variable Groups
# ===========================================
envVarGroups:
  - name: forge-shared
    envVars:
      - key: LOG_LEVEL
        value: info
      - key: SENTRY_DSN
        sync: false
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      - key: S3_BUCKET
        sync: false
      - key: S3_REGION
        value: us-west-2
      - key: S3_ACCESS_KEY
        sync: false
      - key: S3_SECRET_KEY
        sync: false
      - key: S3_ENDPOINT
        sync: false
      - key: SMTP_HOST
        sync: false
      - key: SMTP_PORT
        value: "587"
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASSWORD
        sync: false
      - key: SMTP_FROM
        sync: false
